name: ğŸš€ Build APK - NexusAI

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'www/**'
      - 'config.xml'
      - 'package.json'
      - '.github/workflows/build-apk-github-actions.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      # 1ï¸âƒ£ CODE CHECKOUT
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 2ï¸âƒ£ NODE SETUP
      - name: ğŸ“¦ Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # 3ï¸âƒ£ JAVA SETUP  
      - name: â˜• Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
          cache: gradle
      
      # 4ï¸âƒ£ ANDROID SDK SETUP
      - name: ğŸ”§ Setup Android SDK
        uses: android-actions/setup-android@v3
      
      # 5ï¸âƒ£ INSTALL DEPENDENCIES
      - name: ğŸ”¨ Install Cordova & Dependencies
        run: |
          npm install -g cordova@14.0.1
          npm ci
          echo "âœ… Dependencies installed"
      
      # 6ï¸âƒ£ ADD ANDROID PLATFORM
      - name: ğŸ“± Add Android Platform
        run: |
          cordova platform add android --save
          echo "âœ… Android platform added"
      
      # 7ï¸âƒ£ BUILD APK
      - name: ğŸ—ï¸ Build APK (Release Mode)
        run: |
          cordova build android --release
          echo "âœ… APK build completed"
      
      # 8ï¸âƒ£ FIND & VERIFY APK
      - name: ğŸ” Find APK File
        id: find-apk
        run: |
          APK_PATH=$(find . -type f -name "*.apk" | head -1)
          if [ -z "$APK_PATH" ]; then
            echo "âŒ APK not found!"
            exit 1
          fi
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "APK_PATH=$APK_PATH" >> $GITHUB_OUTPUT
          echo "APK_SIZE=$APK_SIZE" >> $GITHUB_OUTPUT
          echo "âœ… APK Found: $APK_PATH ($APK_SIZE)"
          ls -lh "$APK_PATH"
      
      # 9ï¸âƒ£ RENAME APK
      - name: ğŸ“ Rename APK
        run: |
          OLD_APK="${{ steps.find-apk.outputs.APK_PATH }}"
          NEW_APK="NexusAI-v1.0.0-release.apk"
          mv "$OLD_APK" "$NEW_APK"
          echo "âœ… APK renamed to: $NEW_APK"
          ls -lh "$NEW_APK"
      
      # ğŸ”Ÿ UPLOAD AS ARTIFACT
      - name: ğŸ“¤ Upload APK as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: NexusAI-APK-Release
          path: NexusAI-v1.0.0-release.apk
          retention-days: 90
          if-no-files-found: error
      
      # 1ï¸âƒ£1ï¸âƒ£ CREATE GITHUB RELEASE
      - name: ğŸ‰ Create GitHub Release
        id: create-release
        uses: actions/create-release@v1
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: apk-build-${{ github.run_number }}
          release_name: NexusAI APK v1.0.0 (Build ${{ github.run_number }})
          body: |
            âœ… **APK Ready!**
            
            ğŸ“± **File:** NexusAI-v1.0.0-release.apk
            ğŸ“Š **Size:** ${{ steps.find-apk.outputs.APK_SIZE }}
            ğŸ”— **Built from:** ${{ github.sha }}
            
            **Installation:**
            1. Download APK file
            2. Enable "Unknown Sources" in settings
            3. Install on Android device
            
            **How to use:**
            1. Open NexusAI app
            2. Add your Groq API key
            3. Start chatting!
          draft: false
          prerelease: false
      
      # 1ï¸âƒ£2ï¸âƒ£ UPLOAD TO RELEASE
      - name: ğŸ“¥ Upload APK to Release
        uses: actions/upload-release-asset@v1
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create-release.outputs.upload_url }}
          asset_path: ./NexusAI-v1.0.0-release.apk
          asset_name: NexusAI-v1.0.0-release.apk
          asset_content_type: application/vnd.android.package-archive
      
      # 1ï¸âƒ£3ï¸âƒ£ BUILD SUCCESS
      - name: âœ¨ Build Success Summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… NexusAI APK BUILD SUCCESS!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“± APK File: NexusAI-v1.0.0-release.apk"
          echo "ğŸ“Š Size: ${{ steps.find-apk.outputs.APK_SIZE }}"
          echo "ğŸ”— Releases: https://github.com/${{ github.repository }}/releases"
          echo "ğŸ“¥ Artifacts: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # 1ï¸âƒ£4ï¸âƒ£ BUILD FAILURE
      - name: âŒ Build Failure Summary
        if: failure()
        run: |
          echo "âŒ BUILD FAILED - Check logs above"
          exit 1
