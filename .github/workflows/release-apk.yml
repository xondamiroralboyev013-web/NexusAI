name: Build Release APK (Manual)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install npm dependencies
      run: npm install

    - name: Verify dependencies
      run: npm ci

    - name: Add Android platform
      run: npx cordova platform add android

    - name: Build Release APK
      run: |
        echo "ðŸ“± Building Release APK..."
        npx cordova build android --release
        echo "âœ… Build process completed"
      continue-on-error: true

    - name: Check build output
      run: |
        echo "Checking for APK files..."
        if [ -f "platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
          echo "âœ… Unsigned APK found"
          ls -lh platforms/android/app/build/outputs/apk/release/
        else
          echo "âš ï¸ APK build requires Android SDK setup on your local machine"
          echo "See APK-BUILD-GUIDE.md for local build instructions"
        fi
      continue-on-error: true

    - name: Create release notes
      run: |
        cat > RELEASE_NOTES.md << 'EOF'
        # NexusAI Release ${{ github.event.inputs.version }}
        
        ## Build Instructions
        
        ### Option 1: Use Web Version
        Open `app.html` in your browser - no build needed!
        
        ### Option 2: Build APK Locally
        Follow the guide in `APK-BUILD-GUIDE.md`:
        
        ```bash
        npm install
        cordova platform add android
        cordova build android --release
        ```
        
        ### Requirements
        - Node.js 18+
        - Java 11+
        - Android SDK
        
        ### API Configuration
        Get free key: https://console.groq.com
        
        ### Support
        See DEPLOYMENT-READY.md for complete documentation
        EOF
        cat RELEASE_NOTES.md

    - name: Upload build output
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          RELEASE_NOTES.md
          APK-BUILD-GUIDE.md
          DEPLOYMENT-READY.md
        if-no-files-found: ignore
        retention-days: 30

